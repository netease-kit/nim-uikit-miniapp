<view class="msg-item-wrapper {{msg.pinState && !msg.recallType ? 'msg-pin' : ''}}" id="msg-{{msg.messageClientId}}">
  <!-- 消息时间间隔提示 -->
  <view wx:if="{{msg.messageType === 'custom' && msg.timeValue}}" class="msg-time">
    {{msg.timeValue}}
  </view>
  
  <!-- 撤回消息-可重新编辑 -->
  <view wx:elif="{{msg.messageType === 'custom' && msg.recallType === 'reCallMsg' && msg.canEdit}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{computedTeamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
      <view class="recall-content">
        <text class="recall-text">您撤回了一条消息</text>
        <text class="msg-recall-btn" bindtap="handleReeditMsg">重新编辑</text>
      </view>
    </message-bubble>
  </view>
  
  <!-- 撤回消息-不可重新编辑 -->
  <view wx:elif="{{msg.messageType === 'custom' && msg.recallType === 'reCallMsg' && !msg.canEdit}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{computedTeamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
      <view class="recall-text">您撤回了一条消息</view>
    </message-bubble>
  </view>
  
  <!-- 撤回消息-对方撤回 -->
  <view wx:elif="{{msg.messageType === 'custom' && msg.recallType === 'beReCallMsg'}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{computedTeamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <view class="msg-content">
      <view wx:if="{{msg.showName}}" class="msg-name">{{senderName}}</view>
      <view class="{{msg.isSelf ? 'self-msg-recall' : 'msg-recall'}}">
        <text class="msg-recall2">{{!msg.isSelf ? '撤回了一条消息' : '您撤回了一条消息'}}</text>
      </view>
    </view>
  </view>
  
  <!-- 文本消息 -->
  <view wx:elif="{{msg.messageType === 'text'}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{computedTeamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <view class="msg-content">
      <view wx:if="{{msg.showName}}" class="msg-name">{{senderName}}</view>
      <view wx:if="{{msg.isSelf && showReadStatus}}" class="msg-read-status" bindtap="handleReadDetailClick">
        <message-read readInfo="{{readInfo}}" mode="simple" theme="light" />
      </view>

      <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
        <!-- 回复消息显示 -->
        <view wx:if="{{replyMsg}}" class="reply-message" bindtap="handleReplyMessageClick">
          <view class="reply-line"></view>
          <view class="reply-content">
            <view class="reply-sender">{{replyMsg.senderName || replyMsg.senderId}}</view>
            <block wx:if="{{replyMsg.messageType === 'text' || replyMsg.messageType === 0}}">
              <message-text msg="{{replyMsg}}" fontSize="12" singleLine="{{true}}" />
            </block>
            <block wx:else>
              <view class="reply-text">{{replyPreviewText}}</view>
            </block>
          </view>
        </view>
        <message-text msg="{{msg}}" />
      </message-bubble>
    </view>
  </view>
  
  <!-- 图片消息 -->
  <view wx:elif="{{msg.messageType === 'image'}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{computedTeamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <view class="msg-content">
      <view wx:if="{{msg.showName}}" class="msg-name">{{senderName}}</view>
      <view wx:if="{{msg.isSelf && showReadStatus}}" class="msg-read-status" bindtap="handleReadDetailClick">
        <message-read readInfo="{{readInfo}}" mode="simple" theme="light" />
      </view>
      <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
        <view class="msg-image-wrapper" bindtap="handleImageClick">
          <view wx:if="{{msg.sendingState === 3 || msg.sendingState === 'sending'}}" class="loading-spinner"></view>
          <view wx:elif="{{msg.sendingState === 2 || msg.sendingState === 'failed' || (msg.messageStatus && msg.messageStatus.errorCode !== 200)}}" class="msg-image-fail">
            <image src="https://yx-web-nosdn.netease.im/common/c1f278b963b18667ecba4ee9a6e68047/img-fail.png" />
          </view>
          <image wx:else class="msg-image" src="{{imageUrl}}" mode="aspectFill" lazy-load="{{true}}" />
        </view>
      </message-bubble>
    </view>
  </view>
  
  <!-- 语音消息 -->
  <view wx:elif="{{msg.messageType === 'audio'}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{computedTeamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <view class="msg-content">
      <view wx:if="{{msg.showName}}" class="msg-name">{{senderName}}</view>
      <view wx:if="{{msg.isSelf && showReadStatus}}" class="msg-read-status" bindtap="handleReadDetailClick">
        <message-read readInfo="{{readInfo}}" mode="simple" theme="light" />
      </view>
      <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
        <message-audio msg="{{msg}}" />
      </message-bubble>
    </view>
  </view>
  
  <!-- 视频消息 -->
  <view wx:elif="{{msg.messageType === 'video'}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{computedTeamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <view class="msg-content">
      <view wx:if="{{msg.showName}}" class="msg-name">{{senderName}}</view>
      <view wx:if="{{msg.isSelf && showReadStatus}}" class="msg-read-status" bindtap="handleReadDetailClick">
        <message-read readInfo="{{readInfo}}" mode="simple" theme="light" />
      </view>
      <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
        <message-video msg="{{msg}}" bind:videoClick="handleVideoClick" />
      </message-bubble>
    </view>
  </view>
  
  <!-- 话单消息 -->
  <view wx:elif="{{msg.messageType === 'call'}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{teamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <view class="msg-content">
      <view wx:if="{{msg.showName}}" class="msg-name">{{senderName}}</view>
      <view wx:if="{{msg.isSelf && showReadStatus}}" class="msg-read-status" bindtap="handleReadDetailClick">
        <message-read readInfo="{{readInfo}}" mode="simple" theme="light" />
      </view>
      <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
        <view class="call-message">
          <view class="call-icon">
            <icon type="{{callIconType === 'video' ? 'icon-video-call' : 'icon-audio-call'}}" size="20" color="#337EFF" />
          </view>
          <view class="call-content">
            <view class="call-status">{{callStatusText}}</view>
            <view wx:if="{{callDuration}}" class="call-duration">{{callDuration}}</view>
          </view>
        </view>
      </message-bubble>
    </view>
  </view>
  
  <!-- 文件消息 -->
  <view wx:elif="{{msg.messageType === 'file'}}" 
        class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{teamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <view class="msg-content">
      <view wx:if="{{msg.showName}}" class="msg-name">{{senderName}}</view>
      <view wx:if="{{msg.isSelf && showReadStatus}}" class="msg-read-status" bindtap="handleReadDetailClick">
        <message-read readInfo="{{readInfo}}" mode="simple" theme="light" />
      </view>
      <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
        <message-file msg="{{msg}}" bind:fileClick="handleFileClick" />
      </message-bubble>
    </view>
  </view>
  
  <!-- 通知消息 -->
  <view wx:elif="{{msg.messageType === 'notification'}}" 
        class="msg-notification {{msg.isSelf ? 'msg-self' : ''}}">
    <message-notification 
                       notificationMsg="{{msg}}" 
                       showTime="{{false}}" />
  </view>
  <!-- 未支持的消息类型 -->
  <view wx:else class="msg-common {{msg.isSelf ? 'msg-self' : ''}}">
    <message-avatar 
      wx:if="{{msg.showAvatar}}"
      account="{{msg.senderId}}"
      teamId="{{teamId}}"
      gotoUserCard="{{true}}"
      bind:avatarClick="handleAvatarClick"
    />
    <view wx:else class="avatar-placeholder"></view>
    <view class="msg-content">
      <view wx:if="{{msg.showName}}" class="msg-name">{{senderName}}</view>
      <message-bubble msg="{{msg}}" bgVisible="{{true}}" bind:deleteMsg="handleDeleteMsg" bind:replyMsg="handleReplyMsg" bind:forwardMsg="handleForwardMsg" bind:resendMsg="handleResendMsg">
        <view class="unsupported-msg">
          <text>[不支持的消息类型]</text>
        </view>
      </message-bubble>
    </view>
  </view>
</view>

<cover-view wx:if="{{replyTextPreviewVisible}}" class="reply-text-modal-mask" bindtap="closeReplyTextPreview">
  <cover-view class="reply-text-modal" catchtap="stopPropagation">
    <cover-view class="reply-text-modal__close-floating" catchtap="closeReplyTextPreview">×</cover-view>
    <cover-view class="reply-text-modal__body">
      <cover-view class="reply-text-modal__content">
        {{replyTextContent}}
      </cover-view>
    </cover-view>
    <cover-view class="reply-text-modal__footer">
      <cover-view class="reply-text-modal__copy-btn" catchtap="copyReplyText">复制</cover-view>
    </cover-view>
  </cover-view>
</cover-view>
