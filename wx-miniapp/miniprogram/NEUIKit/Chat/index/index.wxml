<view class="msg-page-wrapper-h5" style="--status-bar-height: {{statusBarHeight}}px; --input-panel-height: {{inputPanelHeight}}px; --network-alert-height: {{networkAlertHeight}}px;">
  <!-- 状态栏占位 -->
  <view class="status-bar-placeholder" style="height: {{statusBarHeight}}px;"></view>
  <!-- 导航栏 -->
  <nav-bar title="{{title}}" showLeft="{{false}}">
  </nav-bar>


  <!-- 网络状态提示 -->
  <view class="msg-alert" id="networkAlert">
    <network-alert theme="{{theme}}" bind:statusChange="handleNetworkStatusChange" />
  </view>

  <!-- 消息列表 -->
  <message-list
    id="messageList"
    conversation-type="{{conversationType || ''}}"
    to="{{to}}"
    msgs="{{msgs}}"
    loading-more="{{loadingMore}}"
    no-more="{{noMore}}"
    reply-msgs-map="{{replyMsgsMap}}"
    theme="{{theme}}"
    bind:loadMore="loadMoreMsgs"
    bind:messageClick="handleMessageClick"
    bind:avatarClick="handleAvatarClick"
    bind:deleteMsg="handleDeleteMessage"
    bind:replyMsg="handleReplyMessage"
    bind:forwardMsg="handleForwardMessage"
    bind:resendMsg="handleResendMessage"
  />

  <!-- 消息输入框 -->
  <message-input
    wx:if="{{!disableInput}}"
    id="messageInput"
    reply-msgs-map="{{replyMsgsMap}}"
    conversation-type="{{conversationType || ''}}"
    to="{{to}}"
    theme="{{theme}}"
    bind:sendTextMsg="handleSendTextMsg"
    bind:sendImageMsg="handleSendImageMsg"
    bind:sendVideoMsg="handleSendVideoMsg"
    bind:sendFileMsg="handleSendFileMsg"
    bind:inputFocus="handleInputFocus"
    bind:inputPanelHeightChange="handleInputPanelHeightChange"
    bind:inputBlur="handleInputBlur"
  />

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">加载中...</view>
  </view>

  <!-- 错误状态 -->
  <view class="error-overlay" wx:if="{{errorMessage}}">
    <view class="error-icon">
      <icon type="warning" size="48" color="#ff3b30" />
    </view>
    <view class="error-text">{{errorMessage}}</view>
    <view class="error-actions">
      <view class="error-close" bindtap="handleCloseError">关闭</view>
      <view class="error-retry" bindtap="handleRetry">重试</view>
    </view>
  </view>

  <!-- 消息操作菜单 -->
  <view class="message-action-menu" wx:if="{{showActionMenu}}" bindtap="hideActionMenu">
    <view class="action-menu-content" catchtap="stopPropagation">
      <view class="action-item" bindtap="handleCopyMessage" wx:if="{{selectedMessage.messageType === 'text'}}">
        <icon type="copy" size="20" />
        <text>复制</text>
      </view>
      <view class="action-item" bindtap="handleReplyMessage" wx:if="{{!(selectedMessage.sendingState === 2 || (selectedMessage.messageStatus && selectedMessage.messageStatus.errorCode!==200))}}">
        <icon type="reply" size="20" />
        <text>回复</text>
      </view>
      <view class="action-item" bindtap="handleForwardMessage" wx:if="{{!(selectedMessage.sendingState === 2 || (selectedMessage.messageStatus && selectedMessage.messageStatus.errorCode!==200))}}">
        <icon type="forward" size="20" />
        <text>转发</text>
      </view>
      <view class="action-item danger" bindtap="handleRecallMessage" wx:if="{{selectedMessage.isSelf}}">
        <icon type="recall" size="20" />
        <text>撤回</text>
      </view>
      <view class="action-item danger" bindtap="handleDeleteMessage">
        <icon type="delete" size="20" />
        <text>删除</text>
      </view>
    </view>
  </view>

  <!-- 确认对话框 -->
  <view class="confirm-modal" wx:if="{{showConfirmModal}}" bindtap="hideConfirmModal">
    <view class="confirm-content" catchtap="stopPropagation">
      <view class="confirm-title">{{confirmTitle}}</view>
      <view class="confirm-message">{{confirmMessage}}</view>
      <view class="confirm-actions">
        <view class="confirm-button cancel" bindtap="handleConfirmCancel">
          取消
        </view>
        <view class="confirm-button confirm" bindtap="handleConfirmOk">
          确定
        </view>
      </view>
    </view>
  </view>

  <!-- 转发弹窗 -->
  <message-forward-modal
    visible="{{showForwardModal}}"
    forwardFromNick="{{forwardFromNick}}"
    friends="{{friends}}"
    teams="{{teams}}"
    recentContacts="{{recentContacts}}"
    theme="{{theme}}"
    multiSelect="{{false}}"
    bind:close="handleForwardModalClose"
    bind:confirm="handleForwardConfirm"
  />
</view>
